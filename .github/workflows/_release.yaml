#
# Copyright (C) 2019-2024 vdaas.org vald team <vald@vdaas.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Run release
on:
  workflow_call:
    inputs:
      client_type:
        type: "string"
        description: "Set client type. e.g) go, python, node, java"
        required: true
    secrets:
      CI_USER:
        required: true
      CI_TOKEN:
        required: true
      GPG_PRIVATE_KEY:
        required: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: rinx/setup-k3d@v0.0.4
        with:
          version: latest
          name: vald
          agents: 1
      - name: Check k3d
        run: |
          kubectl cluster-info
      - uses: azure/setup-helm@v3
      - name: Helm version
        run: |
          helm version
      - name: Get image tag
        id: get_image_tag
        run: |
          TAG="nightly"
          if [[ "$GITHUB_REF" =~ ^refs/tags/.* ]]; then
            TAG=$(echo $GITHUB_REF | sed -e 's:^refs/tags/::' | sed 's/^v\?/v/')
          fi
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "TAG=${TAG}"
      - name: Deploy Vald
        run: |
          helm repo add vald https://vald.vdaas.org/charts
          helm install \
            --values ${VALUES} \
            --set defaults.image.tag=${TAG} \
            --set agent.ngt.dimension=300 \
            --set agent.ngt.auto_index_length=2 \
            --set agent.minReplicas=1 \
            --set gateway.lb.enabled=false \
            --set discoverer.enabled=false \
            --set manager.index.enabled=false \
            --generate-name vald/vald
          sleep 3
          kubectl wait --for=condition=ready pod -l app=vald-agent --timeout=3m
          kubectl get pods
        env:
          VALUES: https://raw.githubusercontent.com/vdaas/vald/main/.github/helm/values/values-lb.yaml
          TAG: ${{ steps.get_image_tag.outputs.TAG }}
      - name: Download data
        run: |
          curl -OL https://raw.githubusercontent.com/rinx/word2vecjson/master/data/wordvecs1000.json
      - name: Install dependencies
        run: |
          make ci/deps
          ## dirty hack:
          sudo rm -rf /usr/lib/python3/dist-packages/validate.py
      - name: Run tests
        run: |
          kubectl port-forward statefulset/vald-agent 8081:8081 &
          pid=$!

          make ci/test

          kill $pid
  release:
    if: startsWith( github.ref, 'refs/tags/')
    needs:
      - e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Create release
        id: create_release
        uses: actions/create-release@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
  publish:
    if: startsWith( github.ref, 'refs/tags/')
    needs:
      - e2e
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 1
      - name: Install dependencies
        run: |
          echo "Install dependencies"
          make ci/deps
      - name: prepare to publish
        run: |
          python3 setup.py sdist
          python3 setup.py bdist_wheel
      # TODO
      # - name: publish
      #   uses: pypa/gh-action-pypi-publish@master
      #   with:
      #     user: ${{ secrets.PIP_USERNAME }}
      #     password: ${{ secrets.PIP_TOKEN }}

name: build protobuf
on:
  workflow_call:
    inputs:
      VALD_CHECKOUT_TARGET_NAME:
        description: "Switch branches or restore working tree files to build vald"
        type: string
        default: main
        required: false

jobs:
  build:
    name: build
    runs-on: ubuntu-20.04
    steps:
      - name: Install dependencies
        run: |
          echo "Install dependencies"
          sudo apt-get update
          sudo apt-get install -y python3-setuptools libprotobuf-dev libprotoc-dev protobuf-compiler
          pip3 install grpcio-tools
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set Git config
        run: |
          git config --global --add safe.directory ${GITHUB_WORKSPACE}
      - name: Clone Vald repository
        working-directory: .github/workflows # NOTE: For debug.
        run: |
          make vald/clone && make VALD_CHECKOUT_TARGET_NAME=${VALD_CHECKOUT_TARGET_NAME} vald/checkout
        env:
          CHECKOUT_TARGET_NAME: ${{ inputs.VALD_CHECKOUT_TARGET_NAME }}
      # - run: |
      #     echo "build"
      #     export GOPATH=$HOME/go
      #     make PYTHON=python3 all
      #     make vald/sha/update
      #     make vald/client/python/version/update
      # - run: |
      #     echo "commit and push"
      #     sha=`make vald/sha/print`
      #     git config --global user.name 'VDaaS org'
      #     git config --global user.email 'ci@vdaas.org'
      #     git remote set-url origin https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/$GITHUB_REPOSITORY
      #     git add .
      #     git commit -m "Update [vald sha: ${sha}]"
      #     git push
      #   env:
      #     GITHUB_USER: ${{ secrets.CI_USER }}
      #     GITHUB_TOKEN: ${{ secrets.CI_TOKEN }}
      # - name: tag
      #   continue-on-error: true
      #   run: |
      #     version=`make vald/client/python/version/print`
      #     git tag ${version}
      #     git push --tags
